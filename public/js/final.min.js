(function(){$(function(){var e;window.models={};window.views={};window.blueIcon="../images/bluepoi.png";window.redIcon="../images/redpoi.png";window.views.MovieMap=Backbone.View.extend({el:".wrapper",initialize:function(){this.infowindow=new google.maps.InfoWindow;this.mapOptions={center:new google.maps.LatLng(37.78493,-122.42942),zoom:3,mapTypeId:google.maps.MapTypeId.ROADMAP};this.map=new google.maps.Map(document.getElementsByClassName("map-canvas")[0],this.mapOptions);_.bindAll(this,"render");this.markers=[];return this},unSelect:function(){_.each(this.markers,function(e){return e.setMap(null)});return this},unBlue:function(){_.each(this.markers,function(e){return e.setIcon(redIcon)});return this},render:function(){var t;t=this;_.each(this.collection.models,function(e){var n,r,i;n=e.toJSON();if(!(n.lng<-125||n.lng>-118||n.lat>39||n.lat<34)){i=new views.LocationMarker({model:e,mapObj:t});r=i.render().marker;t.markers.push(r);r.setMap(t.map);return google.maps.event.addListener(r,"click",function(){return window.app.navigate("/locations/"+n._id,true)})}});$(document.body).removeClass().find(".modal").fadeOut("slow");window.app=new e;Backbone.history.start({pushBack:true});this.bindAutoFill();return this},bindAutoFill:function(){var e;e={compile:function(e){var t;t=_.template(e);return{render:function(e){return t(e)}}}};$(".js-search").typeahead([{name:"movies",local:window.movies.models,header:'<h2><i class="icon-film"></i> Movies:</h2>',template:$("#movie-auto-item").html(),engine:e,limit:15},{name:"locations",local:window.locations.models,header:'<h2><i class="icon-compass-2"></i> Locations:</h2>',template:$("#location-auto-item").html(),engine:e,limit:15}]);return this},events:{"click .new-movies":function(){var e;return e=_.each(this.collection.models,function(e){var t;t=e.get("release_year");if(t>2003&&t<(new Date).getFullYear()){return _.each(e.coords.models,function(e){return e.trigger("select")})}})},"click .fav":function(e){var t,n,r,i;t=$(e.currentTarget);i=t.data("type");n=t.data("id");if(t.hasClass("icon-star")){t.removeClass("icon-star").addClass("icon-star-2").text("Unfavorite")}else if(t.hasClass("icon-star-2")){t.removeClass("icon-star-2").addClass("icon-star").text("Favorite")}r=window[i]._byId[n];r.set("favorite",!r.get("favorite"));r.save();e.stopPropagation();e.stopimmediatePropagation();return e.preventDefault()},"click .js-show-all-points":function(){return _.each(this.markers,function(e){if(e.getMap()===null){return e.setMap(window.map.map)}})}}});return e=Backbone.Router.extend({routes:{"movies/:id":"movie","locations/:id":"location",favorites:function(){var e,t;e=_.filter(window.locations.models,function(e){return typeof e.get("favorite")!=="undefined"&&e.get("favorite")===true});t=_.filter(window.movies.models,function(e){return typeof e.get("favorite")!=="undefined"&&e.get("favorite")===true});return FullViewer.render("favtemplate",{locations:e,movies:t})}},movie:function(e){var t,n;if(window.movies==null){return}n=window.movies._byId[e];t=n.toJSON();t.coords=n.coords;FullViewer.render("movtemplate",t);window.map.unSelect().map.setZoom(12);_.each(n.coords.models,function(e){if(e.marker!=null){e.marker.setMap(window.map.map);return e.marker.setIcon(redIcon)}});if(n.coords.last()!=null){return n.coords.last().trigger("zoomto")}},location:function(e){var t;t=window.locations._byId[e];FullViewer.render("loctemplate",{location:t.toJSON(),movies:t.movies.toJSON()});window.map.unBlue();t.trigger("zoomto");return t.trigger("click")}})});$(function(){var e,t,n,r,i,s,o;o=window.views;i=window.models;String.prototype.sanitize=function(){return this.replace(/"/g,"").replace(/'/g,"")};window.models.Location=Backbone.Model.extend({url:function(){return"/locations/"+this.get("_id")},idAttribute:"_id",initialize:function(){var e,n;this.movies=new t;e=this.toJSON();this.value=n=e.title;return this.tokens=[this.get("_id"),n]}});e=Backbone.Collection.extend({url:"/locations/",model:i.Location});window.models.Movie=Backbone.Model.extend({url:function(){return"/movies/"+this.get("_id")},idAttribute:"_id",initialize:function(){var e;e=this.toJSON();this.value=e.title;return this.tokens=[e._id,e.director,e.producer,e.writer,e.title,e.actor_1,e.actor_2,e.actor_3]},parse:function(t){var n,r;r=this;n=new e;_.each(t.locations,function(e){var t;t=locations._byId[e];if(t!=null){t.movies.add(r);return n.add(t)}});this["coords"]=n;return t}});t=Backbone.Collection.extend({url:"/movies/",model:i.Movie});window.views.LocationMarker=Backbone.View.extend({initialize:function(){var e;_.bindAll(this,"render");this.mapObj=this.options.mapObj;e=this;return this.listenTo(this.model,{hide:function(){if(e.marker!=null){return e.marker.setMap(null)}},zoomto:function(){var t;if(e.marker!=null){t=e.mapObj.map;t.panTo(e.marker.position);e.marker.setIcon(blueIcon);return e.marker.setMap(e.mapObj.map)}},click:function(){if(e.marker!=null){return google.maps.event.trigger(e.marker,"click")}},select:function(){if(e.marker!=null){e.marker.setMap(window.map.map);return e.marker.setIcon(blueIcon)}}})},render:function(){var e,t;t=new google.maps.LatLng(this.model.get("lat"),this.model.get("lng"));this.marker=e=new google.maps.Marker({position:t,animation:google.maps.Animation.DROP,title:this.model.get("title"),icon:redIcon});this.model.marker=e;return this}});window.views.FullMovieOrLocation=Backbone.View.extend({el:".location-data",loctemplate:$("#full-view-location").html(),movtemplate:$("#full-view-movie").html(),favtemplate:$("#faves-template").html(),render:function(e,t){var n;n=$("<div/>").html(_.template(this[e],t));this.$el.html(n);return this}});window.FullViewer=new o.FullMovieOrLocation;window.movies=new t;window.locations=new e;window.map=new o.MovieMap;r=new google.maps.Geocoder;s=function(e,t,n){var r;r=false;return _.each(t,function(t,r){if(t.formatted_address.toLowerCase().indexOf("san francisco")!==-1){console.log("for "+e+" with id "+n+"we have a SF");console.log("at lat "+t.geometry.location.lat());console.log("at lng "+t.geometry.location.lng());return $.ajax({url:"/newlocs/"+n+"/"+t.geometry.location.lat()+"/"+t.geometry.location.lng(),type:"POST",dataType:"json",success:function(e){return console.log(e)}})}})};n=function(e,t){var i;if(e==null){return}e=e.toJSON();i=e.title;if(e.lng<-125||e.lng>-118||e.lat>39||e.lat<34){return window.setTimeout(function(){return r.geocode({address:i},function(r,o){if(o===google.maps.GeocoderStatus.OK){s(i,r,e.title)}else{console.log(o)}return n(window.locations.at(t+1),t+1)})},1e3)}else{return n(window.locations.at(t+1),t+1)}};return locations.fetch({success:function(e){var t;t=e.at(0);window.map.collection=e;return movies.fetch({success:function(){return window.map.render()}})}})})}).call(this)