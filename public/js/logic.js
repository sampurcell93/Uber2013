// Generated by CoffeeScript 1.6.3
(function() {
  $(function() {
    var Locations, Movies, models, views;
    views = window.views;
    models = window.models;
    window.location_table = {};
    window.typeaheadlocations = [];
    String.prototype.sanitize = function() {
      return this.replace(/"/g, "").replace(/'/g, "");
    };
    window.models.Location = Backbone.Model.extend({
      url: "/locations",
      initialize: function() {
        var loc, value;
        this.plotted = false;
        this.movies = new Movies;
        loc = this.toJSON();
        this.value = value = loc.title;
        return this.tokens = [this.get("_id"), value];
      }
    });
    Locations = Backbone.Collection.extend({
      url: "/locations/",
      model: models.Location
    });
    window.models.Movie = Backbone.Model.extend({
      url: "/locations/",
      idAttribute: '_id',
      initialize: function() {
        var movie;
        movie = this.toJSON();
        this.value = movie.title;
        return this.tokens = [movie._id, movie.director, movie.producer, movie.writer, movie.title];
      },
      parse: function(response) {
        var links, self;
        self = this;
        links = new Locations;
        _.each(response.locations, function(id) {
          var link;
          link = locations.findWhere({
            _id: id
          });
          if (link != null) {
            link.movies.add(self);
            return links.add(link);
          }
        });
        this["coords"] = links;
        return response;
      }
    });
    Movies = Backbone.Collection.extend({
      url: '/movies/',
      model: models.Movie,
      initialize: function() {
        return this.markers = [];
      }
    });
    window.views.LocationMarker = Backbone.View.extend({
      initialize: function() {
        var self;
        _.bindAll(this, "render");
        this.mapObj = this.options.mapObj;
        self = this;
        return this.listenTo(this.model, {
          "hide": function() {
            if (self.marker != null) {
              return self.marker.setMap(null);
            }
          },
          "zoomto": function() {
            var map;
            if (self.marker != null) {
              cc("marker exists");
              self.mapObj.unSelect();
              map = self.mapObj.map;
              map.panTo(self.marker.position);
              self.marker.setIcon(blueIcon);
              return google.maps.event.trigger(self.marker, 'click');
            }
          },
          "select": function() {
            if (self.marker != null) {
              cc(blueIcon);
              return self.marker.setIcon(blueIcon);
            }
          }
        });
      },
      render: function() {
        var marker, pt;
        pt = new google.maps.LatLng(this.model.get("lat"), this.model.get("lng"));
        this.marker = marker = new google.maps.Marker({
          position: pt,
          animation: google.maps.Animation.DROP,
          title: this.model.get("title"),
          icon: redIcon
        });
        this.model.marker = marker;
        return this;
      }
    });
    window.views.FullMovieOrLocation = Backbone.View.extend({
      el: '.location-data',
      loctemplate: $("#full-view-location").html(),
      movtemplate: $("#full-view-movie").html(),
      render: function(template, obj) {
        var content;
        content = $("<div/>").html(_.template(this[template], obj));
        this.$el.html(content);
        cc(content);
        return this;
      }
    });
    window.FullViewer = new views.FullMovieOrLocation;
    window.movies = new Movies;
    window.locations = new Locations;
    window.map = new views.MovieMap;
    return locations.fetch({
      success: function(locs) {
        _.each(locs.models, function(loc) {
          loc = loc.toJSON();
          return console.log(loc);
        });
        return movies.fetch({
          success: function(movs) {
            window.map.collection = movs;
            return window.map.render();
          }
        });
      }
    });
  });

}).call(this);
